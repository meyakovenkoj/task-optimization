#include <stdio.h>
#include <stdint.h>
#include <string.h>

#if defined(__linux__)
#include <sched.h>
#endif

#if defined(__APPLE__)
#include <time.h>
#endif

static uint64_t get_cpu_counter(void)
{
    uint64_t c64;
#if defined(__e2k__)
#pragma asm_inline
    asm("rrd %%clkr, %0" : "=r" (c64));
#elif defined(__aarch64__) && defined(__APPLE__)
    c64 = clock_gettime_nsec_np(CLOCK_PROCESS_CPUTIME_ID) * 3.2;
#else
    c64 = __builtin_ia32_rdtsc();
#endif
    return c64;
}

void reduction(uint64_t *x, const uint64_t *n, size_t len, uint64_t rho, uint64_t alpha, uint64_t *magic);

int main(void)
{
    uint64_t n_orig[64] = {5047058052987665531ull, 1617132306661920942ull, 11043770555982812398ull, 8132768528726538667ull, 17859873442417925046ull,
            9170148633928117787ull, 1330130399205018466ull, 3050015407584237984ull, 735355225178858424ull, 6091661472607987127ull, 17834971219544888978ull,
            16201774851018553876ull, 7560813824715526246ull, 14150712059375309123ull, 10548439221460372339ull, 5931879579449339698ull,
            12928940693774058557ull, 8803205768829738666ull, 6434939784627107729ull, 16601311050660574413ull, 14361173080629089840ull,
            18318625113036439316ull, 8326800014488901377ull, 7986335044919467867ull, 3116120153780585690ull, 17141360250315904104ull, 6170015704205494116ull,
            1998460889839244186ull, 6126050147996279474ull, 7169483059467102350ull, 12361153148249531791ull, 6668670154763587068ull, 11547740583127884759ull,
            3535261176671087016ull, 17376543531674831250ull, 2549835605870175114ull, 9923081244250559606ull, 771353252159952657ull, 2949392883141380341ull,
            11408790711843125115ull, 2782799255951146071ull, 15114840187559254611ull, 11888808927841904648ull, 4514559164225037163ull,
            11223054251331205212ull, 12054421348453432996ull, 2887602189479565181ull, 279317553366144041ull, 13613827420204349157ull, 8546677910403746337ull,
            4047796589492437903ull, 16384992734325153470ull, 287271723060996171ull, 12177497389100839930ull, 14633059945303480617ull, 16582114509947650632ull,
            11898341849069474597ull, 6281839148213249036ull, 17672045771826787799ull, 15000316405548459147ull, 386965009003739854ull, 17566316655714120006ull,
            5971967290259896708ull, 12858177248508843118ull};
    uint64_t x_orig[129] = {7930801981145595076ull, 6405194765453884320ull, 2630009864848106832ull, 13118410652235642017ull, 14486568050876202418ull,
            14327393623161484616ull, 17321587286457328150ull, 11288544228825359917ull, 2180106870177124681ull, 13251966823766453033ull,
            14371590566829720870ull, 16273770765128951168ull, 11734433295476383730ull, 13168331321805035539ull, 4438245655721001120ull,
            4284979337449906164ull, 14027799309106572104ull, 2320322088142346180ull, 2997521467428718356ull, 17537471535643510665ull, 9528826355092440745ull,
            10917240056101633954ull, 15019934232586751046ull, 3354450580445048620ull, 17914093438403280433ull, 12164760309657134294ull,
            11387755182250848664ull, 11227572837510889388ull, 10099735842013724183ull, 7007564291141151409ull, 8943687168262895034ull,
            11791909232081458118ull, 17566576301932930750ull, 3611858300513972961ull, 12343443506928423274ull, 12120702665387051324ull,
            14619344518015723378ull, 9780612999556787420ull, 5170881085562178997ull, 2284846047768491965ull, 8056099632294765321ull, 285995057212983603ull,
            18203015331049401433ull, 11773781363831597685ull, 5839117043725311744ull, 11502406286345635952ull, 10372306609842743930ull,
            14537187821200254406ull, 6330502293955232433ull, 11222770131879494163ull, 9942588567896443559ull, 7922365281899044443ull, 7657938875308526885ull,
            12411460099334524674ull, 17696489423732785567ull, 15299513276543224327ull, 15220403452946840070ull, 8300948700097391832ull,
            16495274430676421636ull, 9971789296339164999ull, 1733707988070614245ull, 1781345675459873018ull, 3019435446339344957ull, 11553122261773459458ull,
            1541597943963367861ull, 5792303155895416175ull, 8798158856308208946ull, 2447874263714082266ull, 8610582061712551092ull, 11526062513248772325ull,
            9144361883567872007ull, 5043290804187791718ull, 11083767734713459538ull, 5688679123459334132ull, 9231029152084955540ull, 17120578552063716204ull,
            1653139844852589894ull, 15840040566715064274ull, 12803993062145224375ull, 1008386942858670947ull, 3461894424520866591ull, 7616307139300160487ull,
            6664408552468296324ull, 16765310059572248657ull, 375997618536350449ull, 9936511990754762074ull, 9046380268279603796ull, 6709270815812286881ull,
            8227052782744694413ull, 6604656677284855468ull, 5946517763789431171ull, 18249874829140970862ull, 5709947535083307551ull, 5335630288164436321ull,
            17595997257414867806ull, 14045449544003345444ull, 411525916761004344ull, 15768077895988895466ull, 7989805224270628318ull, 8396559382127612807ull,
            5348363784821606558ull, 11867874333374307443ull, 9521738208309196931ull, 8633450033019627853ull, 14860017296622514630ull, 3530232391426998586ull,
            11027152425005166135ull, 10655283407271116380ull, 11368814900531540942ull, 12440050386735442221ull, 2368526966163154206ull,
            12565413959305371293ull, 14745553584326482415ull, 17612608898597513968ull, 17586788705527269343ull, 5636093791211129278ull,
            9022577462780048798ull, 11588524239517593833ull, 15557402006719128787ull, 17608343234183273877ull, 13069599012247670359ull, 640605109282640252ull,
            14589515976467997330ull, 16620281562497162743ull, 870634894166716313ull, 4266586259806765388ull, 10710614574719207819ull, 151954440072308552ull,
            0ull};
    uint64_t correct_result[129] = {0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x277168c9cc0d74d2, 0xf41cb78a638a29d5, 0x2b2275f50de32596, 0x529e1713905de516, 0x4c199404247878a5, 0xaf2796b3ca1e35af, 0x842f016598dbdc9e, 0xbffa97ae0a111090, 0x279f135f3baaf433, 0xd3cdd4c4a8a453d7, 0x8631d7e7835cf972, 0x33bd9bb9c49d8d09, 0x91022e3daef6d31a, 0x52a50433143c807a, 0xb06a59f9925fec98, 0x37b2ec03966801ef, 0x95e91d9f4b6dc53e, 0xea051b02526adff9, 0xe05fb3027c5be5a0, 0xfa930fb6d55d77e2, 0x571397d0bc8ec4fc, 0x31db8187a9cc6722, 0x99baf53528bd45c8, 0xd16ad69c4919141a, 0xe181bcbe4392981f, 0x2e7f83313c56602b, 0xd88c918ee2172800, 0x9af86d3099167cb9, 0x92397c89177bc61a, 0xc201fb7d36cb9c56, 0xa9a37753a664097, 0xaa8bcbdee5b0689, 0x3fd4d9258952efcc, 0x3741c18b494ac8b0, 0x37f197939f81ca84, 0xf5033d112f651450, 0xca27385e2cceb71c, 0x4a79b09abcf6856e, 0x2446a2262e099f1d, 0xed00db8c0ca7b139, 0xd1cfb69c28cd9aa3, 0x35f3fc6228bad1e8, 0x98b1f3ef8ad4d1ca, 0xff56f35559bf41d4, 0x9cde9d88b550f60f, 0x91755689edeac14c, 0x7345bfdcadc61556, 0x603f799a3ceaf3b0, 0xb45f56d852041dbf, 0x134ed545b2952486, 0x6c04c467706245a3, 0xaf2d584e0b42b6f1, 0x1b430953c4e1d09e, 0xe05fbd929b7afc87, 0xc4eb00f9e39a7c1b, 0xb6eccb098183d7f6, 0x210eb063ea18733d, 0xbf18ef6ee0d1cd94, 0xf68f4e3bbffd676, 0x984ac0a461cd9a60, 0x6cfd814dc974863f, 0x4828abe4059d5049, 0xc982e2b229f2fc71, 0xae570f57c96449e0, 0x0};
    uint64_t len = 64;
    uint64_t rho = 17123281437452418381ull;
    uint64_t alpha = 0;
    uint64_t magic = 42;

    uint64_t n[64];
    uint64_t x[129];

#if defined(__linux__)
    // Фиксируем выполнение на одном ядре.
    cpu_set_t set;
    CPU_ZERO(&set);
    CPU_SET(0, &set);
    sched_setaffinity(0, sizeof(set), &set);
#endif
    memcpy(n, n_orig, sizeof(n_orig));
    memcpy(x, x_orig, sizeof(x_orig));

    reduction(x, n, len, rho, alpha, &magic);
    if (memcmp(x, correct_result, sizeof(correct_result)) != 0) {
        printf("Mismatch! Computed value:\n");
        for (uint64_t i = 0; i < 2 * len + 1; ++i) {
            printf("0x%lx, ", x[i]);
        }
        printf("\n");
        return 1;
    }
    printf("Computed value is correct!\n");

    int repeat = 1000;
    uint64_t start_clock = get_cpu_counter();
    for (int i = 0; i < repeat; ++i) {
        memcpy(n, n_orig, sizeof(n_orig));
        memcpy(x, x_orig, sizeof(x_orig));
        reduction(x, n, len, rho, alpha, &magic);
    }
    uint64_t end_clock = get_cpu_counter();

    printf("PERF: %.2f clocks per call\n", (double) (end_clock - start_clock) / repeat);

    return 0;
}
